Bootstrap: docker
From:  nvidia/cuda:12.4.1-runtime-ubuntu22.04

%labels
    Author Marc Cummings
    Version 1.3
    Model GPT-OSS-120B
    Type Text-only
    Build for H100 (sm_90)
    Note Uses pre-built kernels from kernels-community

%environment
    export MODEL_PATH=/opt/models/gpt-oss-120b
    export PYTHONUNBUFFERED=1
    export PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True

%post
    # 1. Basic utilities
    apt-get update && apt-get install -y \
        python3 python3-pip git curl wget \
        && rm -rf /var/lib/apt/lists/*

    # 2. Upgrade pip
    pip3 install --upgrade pip

    # 3. Install PyTorch
    pip3 install torch

    # 4. Install Triton
    pip3 install triton==3.4

    # 5. Install kernels
    pip3 install kernels

    # 6. Install Transformers & others
    pip3 install --upgrade transformers accelerate sentencepiece

    # Create model directory
    mkdir -p /opt/models/

%files
    ./models/gpt-oss-120b /opt/models/gpt-oss-120b
    ./containers/gpt-oss-120b/run.py /opt/run.py

%runscript
    exec python3 /opt/run.py "$@"
