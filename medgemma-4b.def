Bootstrap: docker
From: nvidia/cuda:12.1.1-cudnn8-devel-ubuntu22.04

%labels
    Author Marc Cummings
    Version 1.0
    Model MedGemma-4B
    Type Multimodal

%environment
    export MODEL_PATH=/opt/models/medgemma-4b-it
    export PYTHONUNBUFFERED=1

%post
    # Basic utilities
    apt-get update && apt-get install -y \
        python3 python3-pip git curl wget vim \
        && rm -rf /var/lib/apt/lists/*

    # Install Python dependencies
    pip3 install --upgrade pip
    pip3 install torch torchvision --index-url https://download.pytorch.org/whl/cu126
    pip3 install transformers pillow accelerate sentencepiece

    # Install Flash Attention via PRE-BUILT WHEEL
    pip3 install https://github.com/Dao-AILab/flash-attention/releases/download/v2.8.3/flash_attn-2.8.3+cu12torch2.5cxx11abiFALSE-cp310-cp310-linux_x86_64.whl

    # Create model directory
    mkdir -p /opt/models/

%files
    # Copy downloaded MedGemma 4B model into the container
    ./models/medgemma-4b-it /opt/models/medgemma-4b-it
    ./run_4b.py /opt/run.py

%runscript
    exec python3 /opt/run.py "$@"
